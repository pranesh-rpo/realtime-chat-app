<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order History - QudPik</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#">QudPik</a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="index.html">Home</a>
        <a class="nav-link" href="cart.html">Cart</a>
        <a class="nav-link" href="profile.html">Profile</a>
        <a class="nav-link" href="#" id="logoutBtn">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <h1 class="text-center mb-4">Order History</h1>
    <div id="ordersContainer">
      <!-- Orders will be loaded here -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      updateAuthUI();
      loadOrderHistory();

      document.getElementById('logoutBtn').addEventListener('click', logout);
    });

    function loadOrderHistory() {
      fetch('/api/orders')
        .then(response => response.json())
        .then(orders => {
          if (orders.error) {
            document.getElementById('ordersContainer').innerHTML = '<p class="text-center">Please login to view your order history.</p>';
            return;
          }

          const ordersContainer = document.getElementById('ordersContainer');
          if (orders.length === 0) {
            ordersContainer.innerHTML = '<p class="text-center">No orders found.</p>';
            return;
          }

          // Group orders by order ID
          const orderGroups = {};
          orders.forEach(order => {
            if (!orderGroups[order.id]) {
              orderGroups[order.id] = {
                id: order.id,
                total_amount: order.total_amount,
                shipping_address: order.shipping_address,
                status: order.status,
                created_at: order.created_at,
                items: []
              };
            }
            orderGroups[order.id].items.push({
              name: order.jersey_name,
              quantity: order.quantity,
              price: order.price
            });
          });

          ordersContainer.innerHTML = Object.values(orderGroups).map(order => `
            <div class="card mb-4">
              <div class="card-header">
                <h5>Order #${order.id}</h5>
                <small class="text-muted">Placed on ${new Date(order.created_at).toLocaleDateString()}</small>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-8">
                    <h6>Items:</h6>
                    <ul class="list-group list-group-flush">
                      ${order.items.map(item => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          ${item.name}
                          <span class="badge bg-primary rounded-pill">${item.quantity} x $${item.price}</span>
                        </li>
                      `).join('')}
                    </ul>
                  </div>
                  <div class="col-md-4">
                    <div class="text-end">
                      <p><strong>Total: $${order.total_amount}</strong></p>
                      <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></p>
                      <p><strong>Shipping Address:</strong><br>${order.shipping_address}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
        })
        .catch(error => console.error('Error loading order history:', error));
    }

    function getStatusColor(status) {
      switch (status) {
        case 'pending': return 'warning';
        case 'processing': return 'info';
        case 'shipped': return 'primary';
        case 'delivered': return 'success';
        case 'cancelled': return 'danger';
        default: return 'secondary';
      }
    }

    function logout() {
      fetch('/api/logout', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            sessionStorage.clear();
            window.location.href = 'index.html';
          }
        })
        .catch(error => console.error('Error logging out:', error));
    }
  </script>
</body>
</html>
